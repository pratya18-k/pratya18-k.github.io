<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการการเงินส่วนตัว</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tab-navigation {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tab-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .card-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 1200px;
        }

        .table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 12px;
            border: 1px solid #fff;
        }

        .table td {
            padding: 8px 6px;
            border: 1px solid #ddd;
            font-size: 11px;
            white-space: nowrap;
        }

        .table tr:hover {
            background-color: #f8f9fa;
        }

        .table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .amount-cell {
            text-align: right;
            font-weight: 600;
            color: #dc3545;
        }

        .income-amount {
            color: #28a745;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            word-wrap: break-word;
        }

        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }
        .notification.warning { background: #ffc107; color: #212529; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff40;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tab-navigation {
                justify-content: stretch;
            }
            
            .tab-btn {
                flex: 1;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ระบบจัดการการเงินส่วนตัว</h1>
            <p>บันทึกรายรับ-รายจ่าย และจัดการฐานข้อมูล</p>
        </div>

        <div class="tab-navigation">
            <button class="tab-btn active" onclick="showTab('transaction')">บันทึกรายการ</button>
            <button class="tab-btn" onclick="showTab('report')">รายงานสรุป</button>
        </div>

        <div id="transaction" class="tab-content active">
            <div class="form-grid">
                <div class="card">
                    <h2 class="card-title">บันทึกรายการใหม่</h2>
                    
                    <form id="transactionForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">วันที่</label>
                                <input type="date" class="form-input" id="date" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">วันในสัปดาห์</label>
                                <input type="text" class="form-input" id="dayOfWeek" readonly style="background: #f8f9fa;">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ประเภท</label>
                            <select class="form-select" id="transactionType" required>
                                <option value="">เลือกประเภท</option>
                                <option value="Income">รายรับ (Income)</option>
                                <option value="Expenses">รายจ่าย (Expenses)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">หมวดหมู่หลัก</label>
                            <select class="form-select" id="category" required>
                                <option value="">เลือกหมวดหมู่หลัก</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">หมวดหมู่ย่อย</label>
                            <select class="form-select" id="subCategory" required>
                                <option value="">เลือกหมวดหมู่ย่อย</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ประเภทการชำระ</label>
                                <select class="form-select" id="paymentType" required>
                                    <option value="">เลือกประเภทการชำระ</option>
                                    <option value="Bank">Bank</option>
                                    <option value="CreditCard">CreditCard</option>
                                    <option value="Wallet">Wallet</option>
                                    <option value="Cash">Cash</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">รายละเอียดการชำระ</label>
                                <select class="form-select" id="paymentDetail" required>
                                    <option value="">เลือกรายละเอียด</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">รายละเอียด</label>
                                <input type="text" class="form-input" id="detail" list="detailSuggestions" placeholder="ระบุรายละเอียด หรือเลือกจากรายการที่เคยบันทึก" required>
                                <datalist id="detailSuggestions"></datalist>
                            </div>
                            <div class="form-group">
                                <label class="form-label">จำนวนเงิน (บาท)</label>
                                <input type="number" class="form-input" id="amount" step="0.01" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">หมายเหตุ</label>
                            <input type="text" class="form-input" id="comment" placeholder="หมายเหตุเพิ่มเติม">
                        </div>

                        <button type="submit" class="btn" style="width: 100%;">บันทึกรายการ</button>
                        <button type="button" class="btn" id="syncButton" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);" onclick="syncToGoogleSheets()">
                            บันทึกและส่งไป Google Sheets
                        </button>
                    </form>
                </div>

                <div class="card">
                    <h2 class="card-title">สรุปข้อมูล</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalTransactions">0</div>
                            <div class="stat-label">จำนวนรายการทั้งหมด</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalIncome">฿0</div>
                            <div class="stat-label">รายรับรวม</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalExpenses">฿0</div>
                            <div class="stat-label">รายจ่ายรวม</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="netAmount">฿0</div>
                            <div class="stat-label">คงเหลือ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="report" class="tab-content">
            <div class="card">
                <h2 class="card-title">รายงานและตารางข้อมูล</h2>
                
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="loadSampleData()">โหลดข้อมูลตัวอย่าง</button>
                    <button class="btn btn-danger" onclick="clearAllData()">ล้างข้อมูลทั้งหมด</button>
                    <button class="btn btn-success" onclick="exportToCSV()">ส่งออก CSV</button>
                    <button class="btn" onclick="exportToJSON()">ส่งออก JSON</button>
                    <button class="btn" id="syncAllButton" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);" onclick="syncAllToGoogleSheets()">ส่งทั้งหมดไป Google Sheets</button>
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Categorize</th>
                                <th>Type</th>
                                <th colspan="2">Payment</th>
                                <th>Detail</th>
                                <th>Fund</th>
                                <th>Income</th>
                                <th>Expenses</th>
                                <th>Atth</th>
                                <th>Comment</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody">
                            <tr>
                                <td colspan="13" style="text-align: center; padding: 30px; color: #666;">
                                    ยังไม่มีข้อมูลรายการ
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let transactions = [];
        let database = {};

        // Updated Google Sheets URL
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwB-GWz0h2q4ACcbp69AXvYg3PK0gcmh-s--tRFrz_mvSR3PeeTw2d4rI3NGYBC32yTjrQ/exec';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeDatabase();
            initializeDetailOptions();
            loadDataFromStorage();
            document.getElementById('date').valueAsDate = new Date();
            updateDayOfWeek();
            updateStats();
            updateTransactionTable();
            
            loadAllDetailSuggestions();
        });

        // Load All Detail Suggestions
        function loadAllDetailSuggestions() {
            const datalist = document.getElementById('detailSuggestions');
            datalist.innerHTML = '';
            
            window.predefinedDetails.forEach(detail => {
                const option = document.createElement('option');
                option.value = detail;
                option.textContent = detail;
                datalist.appendChild(option);
            });
        }

        // Initialize Detail Options
        function initializeDetailOptions() {
            window.predefinedDetails = [
                'เงินเดือน',
                'เงินปันผลกองทุน',
                'เงินปันผลหุ้น',
                'เงินขายกองทุน',
                'ดอกเบี้ย',
                'รับโอนเงิน promptpay จาก KTB-NON',
                'รับโอนเงิน promptpay จาก KTB-BKK',
                'รับโอนเงิน promptpay จาก SCB',
                'รับโอนเงิน promptpay จาก K-Bank',
                'รับโอนเงิน promptpay จาก ไป Krungsri',
                'รับโอนเงิน promptpay จาก GSB',
                'ค่า NetFlix รายเดือน คุณนัท',
                'ค่า NetFlix รายเดือน เบียร์',
                'ค่า NetFlix รายเดือน พี่แสน',
                'เงินค่ารักษาพยาบาลตัวเอง',
                'เงินค่ารักษาพยาบาลตัวพ่อ',
                'เงินค่ารักษาพยาบาลแม่',
                'เงินค่ารักษาพยาบาลลูก',
                'แฟนโอนเงินทดรองจ่าย',
                'รายจ่ายประจำเดือน',
                'โอนเงิน promptpay ไป KTB-NON',
                'โอนเงิน promptpay ไป KTB-BKK',
                'โอนเงิน promptpay ไป Krungsri',
                'โอนเงิน promptpay ไป GSB',
                'โอนเงิน promptpay ไป BBL',
                'โอนเงิน promptpay ไป K-Bank',
                'โอนเงิน promptpay ไป SCB',
                'โอนเงิน promptpay ไป TTB',
                'โอนเงินเข้า Shopee Pay',
                'โอนเงินเข้า PLANET SCB',
                'โอนเงินเข้า Shopee Pay Achi',
                'โอนเงินเข้า Shopee Pay Pool',
                'โอนเงินเข้า Bitcoin (Bitkub)',
                'ฝากเงินเข้า Bitcoin (Bitkub)',
                'โอนเงินเข้า เป๋าตัง',
                'โอนเงินเข้า PLANET SCB',
                'งบรายจ่ายประจำเดือนให้แฟน',
                'ค่าน้ำมัน (32.6 /L : 23.62 L)',
                'ค่าทางด่วน EasyPass',
                'ค่า NetFlix รายเดือน',
                'ค่า icloud รายเดือน',
                'ค่า Youtube premium',
                'ค่าโทรศัพท์รายเดือน AIS',
                'ค่า internet NT',
                'ค่าธรรมเนียมบัตรรายปี',
                'จ่ายบัตรเครดิต CardX',
                'จ่ายบัตรเครดิต KTC',
                'จ่ายบัตรเครดิต Krungsri',
                'จ่ายบัตรเครดิต FirstChoice',
                'ค่าซื้อของ BIG C',
                'ค่าซื้อของ BIG C Mini',
                'ค่าซื้อของ Tesco',
                'ค่ารักษาพยาบาลตัวเอง',
                'ค่ารักษาพยาบาลลูก',
                'ค่ารักษาพยาบาลพ่อ',
                'ค่ารักษาพยาบาลแม่',
                'ค่าวัคซีนลูก',
                'ค่าฉีด Vaccine',
                'เติมมือถือตัวเอง',
                'เติมมือถือพ่อ',
                'เติมมือถือแม่',
                'ซื้อสลากดิจิตอล N3',
                'ซื้อสลากดิจิตอล N6',
                'เงินออมทอง',
                'เงินซื้อกองทุน',
                'เงินซื้อหุ้น',
                'เงินทดรองจ่ายให้แฟน',
                'ค่าอาหารเสริม Narah',
                'Latte Cafe Amazon',
                'Blackmore Bio C 1000 mg DAILY IMU+',
                'Blackmore Vitamin C 1000 Mg',
                'Blackmore Mega B Complex',
                'Blackmore Bio Zinc 168 Tablets',
                'Intensive Hair Serum Nectapharma',
                'Shampoo Lyo',
                'CUPhar Biotin Zinc Plus',
                'Narah Jiaogulan Capsule',
                'Narah Alfalfa Juice powder',
                'Narah Red BEET Juice Powder',
                'Narah Carrot Juice powder',
                'Narah Premium Collagen',
                'Narah Alfalfa + Narah Red BEET+Narah Carrot Juice powder',
                'ทำบุญ',
                'บริจาคเงินมูลนิธิ',
                'ค่าประกันสุขภาพลูก',
                'งบรายจ่ายประจำเดือนให้แฟน',
                'เงินสำรองจ่ายให้แฟน'
            ];
        }

        // Initialize Database
        function initializeDatabase() {
            database = {
                "Income": {
                    "Salary": {
                        "Monthly": ["Bank KTB-NON", "Bank BBL", "Bank K-Bank"]
                    },
                    "Investment": {
                        "Dividend": ["Bank BBL", "Bank KTB-BKK", "Bank K-Bank", "Bank Krungsri", "Bank SCB"],
                        "Interest": ["Bank BBL", "Bank KTB-NON", "Bank KTB-BKK", "Bank K-Bank"]
                    }
                },
                "Expenses": {
                    "Medical Expenses": {
                        "pranangklaohospital": ["Bank KTB-NON"],
                        "Dent CHULA": ["CreditCard KTC", "Bank KTB-NON"],
                        "Vaccine": ["Bank KTB-NON", "CreditCard KTC", "Cash"],
                        "Clinic": ["Bank KTB-NON"],
                        "Hospital": ["Bank KTB-NON", "CreditCard KTC"]
                    },
                    "Utility Bills": {
                        "Top up phone": ["Bank K-Bank", "Bank KTB-NON"],
                        "Internet Home": ["Bank KTB-NON"],
                        "Phone Bill": ["Bank KTB-NON"],
                        "Entertainment": ["Bank KTB-NON"]
                    },
                    "Investment": {
                        "Fund": ["Bank K-Bank", "Bank KTB-NON", "Bank SCB"],
                        "Gold Saving": ["Bank KTB-NON"],
                        "BitCoin": ["Bank KTB-NON", "Bank KTB-BKK"],
                        "Dividend/Stock-AIT": ["Bank KTB-BKK"]
                    },
                    "Shopping": {
                        "Gadget / Online/Shopee": ["Bank KTB-NON"],
                        "Food & Drink": ["Cash", "Bank KTB-NON", "Bank K-Bank"],
                        "Personal Care Product": ["Bank KTB-NON"]
                    },
                    "Transfer Money": {
                        "Etc.": ["Bank KTB-NON", "Bank KTB-BKK"]
                    }
                }
            };

            window.paymentDetailsDB = {
                "Bank": ["KTB-NON", "KTB-BKK", "K-Bank", "BBL", "SCB", "Krungsri", "TTB", "GSB"],
                "CreditCard": ["KTC", "FirstChoice", "Krungsri Card", "Krungsri_JCB", "Card X", "PLANET SCB"],
                "Wallet": ["Shopee Pay", "Blue Connect", "True Money", "เปาตัง", "PLANET SCB", "Lazada Wallet"],
                "Cash": [""]
            };
        }

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Date Change Handler
        document.getElementById('date').addEventListener('change', updateDayOfWeek);

        function updateDayOfWeek() {
            const dateInput = document.getElementById('date');
            const dayOfWeekInput = document.getElementById('dayOfWeek');
            
            if (dateInput.value) {
                const date = new Date(dateInput.value);
                const days = ['วันอาทิตย์', 'วันจันทร์', 'วันอังคาร', 'วันพุธ', 'วันพฤหัสบดี', 'วันศุกร์', 'วันเสาร์'];
                dayOfWeekInput.value = days[date.getDay()];
            }
        }

        // Event Handlers
        document.getElementById('transactionType').addEventListener('change', function() {
            const type = this.value;
            populateCategories(type);
        });

        document.getElementById('category').addEventListener('change', function() {
            const type = document.getElementById('transactionType').value;
            const category = this.value;
            populateSubCategories(type, category);
        });

        document.getElementById('subCategory').addEventListener('change', function() {
            const type = document.getElementById('transactionType').value;
            const category = document.getElementById('category').value;
            const subCategory = this.value;
            
            updateDetailSuggestions(type, category, subCategory);
        });

        document.getElementById('paymentType').addEventListener('change', function() {
            populatePaymentDetails(this.value);
        });

        // Populate Payment Details
        function populatePaymentDetails(paymentType) {
            const paymentDetailSelect = document.getElementById('paymentDetail');
            paymentDetailSelect.innerHTML = '<option value="">เลือกรายละเอียด</option>';
            
            if (paymentType && window.paymentDetailsDB && window.paymentDetailsDB[paymentType]) {
                window.paymentDetailsDB[paymentType].forEach(detail => {
                    if (detail) {
                        paymentDetailSelect.innerHTML += `<option value="${detail}">${detail}</option>`;
                    }
                });
            }
        }

        // Populate Categories
        function populateCategories(type) {
            const categorySelect = document.getElementById('category');
            categorySelect.innerHTML = '<option value="">เลือกหมวดหมู่หลัก</option>';
            
            if (type && database[type]) {
                Object.keys(database[type]).forEach(category => {
                    categorySelect.innerHTML += `<option value="${category}">${category}</option>`;
                });
            }
        }

        // Populate Sub Categories
        function populateSubCategories(type, category) {
            const subCategorySelect = document.getElementById('subCategory');
            subCategorySelect.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย</option>';
            
            if (type && category && database[type] && database[type][category]) {
                Object.keys(database[type][category]).forEach(subCategory => {
                    subCategorySelect.innerHTML += `<option value="${subCategory}">${subCategory}</option>`;
                });
            }
        }

        // Update Detail Suggestions
        function updateDetailSuggestions(type, category, subCategory) {
            const datalist = document.getElementById('detailSuggestions');
            datalist.innerHTML = '';
            
            const relatedTransactions = transactions.filter(t => 
                t.type === type && 
                t.category === category && 
                t.subCategory === subCategory
            );
            
            const allDetails = [...window.predefinedDetails];
            
            relatedTransactions.forEach(t => {
                if (!allDetails.includes(t.detail)) {
                    allDetails.push(t.detail);
                }
            });
            
            const detailFrequency = {};
            relatedTransactions.forEach(t => {
                detailFrequency[t.detail] = (detailFrequency[t.detail] || 0) + 1;
            });
            
            allDetails.sort((a, b) => {
                const aFreq = detailFrequency[a] || 0;
                const bFreq = detailFrequency[b] || 0;
                
                if (aFreq > 0 && bFreq === 0) return -1;
                if (aFreq === 0 && bFreq > 0) return 1;
                if (aFreq > 0 && bFreq > 0) return bFreq - aFreq;
                return 0;
            });
            
            allDetails.forEach(detail => {
                const option = document.createElement('option');
                option.value = detail;
                if (detailFrequency[detail]) {
                    option.textContent = `${detail} (ใช้ ${detailFrequency[detail]} ครั้ง)`;
                } else {
                    option.textContent = detail;
                }
                datalist.appendChild(option);
            });
        }

        // Transaction Form Submit
        document.getElementById('transactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const paymentType = document.getElementById('paymentType').value;
            const paymentDetail = document.getElementById('paymentDetail').value;
            const paymentMethod = paymentType + (paymentDetail ? ' ' + paymentDetail : '');
            
            const now = new Date();
            const transaction = {
                id: Date.now(),
                date: document.getElementById('date').value,
                time: now.toLocaleTimeString('th-TH', { hour12: false }),
                dayOfWeek: document.getElementById('dayOfWeek').value,
                type: document.getElementById('transactionType').value,
                category: document.getElementById('category').value,
                subCategory: document.getElementById('subCategory').value,
                paymentType: paymentType,
                paymentDetail: paymentDetail,
                paymentMethod: paymentMethod,
                detail: document.getElementById('detail').value,
                amount: parseFloat(document.getElementById('amount').value),
                comment: document.getElementById('comment').value || '',
                fund: '',
                atth: `CustomerPhotos/Sept-2025/${String(Math.floor(Math.random() * 100)).padStart(2, '0')}`
            };

            transactions.push(transaction);
            saveDataToStorage();
            updateStats();
            updateTransactionTable();
            
            const currentType = document.getElementById('transactionType').value;
            const currentCategory = document.getElementById('category').value;
            const currentSubCategory = document.getElementById('subCategory').value;
            if (currentType && currentCategory && currentSubCategory) {
                updateDetailSuggestions(currentType, currentCategory, currentSubCategory);
            }
            
            this.reset();
            document.getElementById('date').valueAsDate = new Date();
            updateDayOfWeek();
            
            showNotification('บันทึกรายการเรียบร้อยแล้ว!', 'success');
        });

        // Update Statistics
        function updateStats() {
            const income = transactions.filter(t => t.type === 'Income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'Expenses').reduce((sum, t) => sum + t.amount, 0);
            const total = transactions.length;
            const net = income - expenses;

            document.getElementById('totalTransactions').textContent = total;
            document.getElementById('totalIncome').textContent = formatCurrency(income);
            document.getElementById('totalExpenses').textContent = formatCurrency(expenses);
            document.getElementById('netAmount').textContent = formatCurrency(net);
        }

        // Update Transaction Table
        function updateTransactionTable() {
            const tableBody = document.getElementById('transactionTableBody');
            const data = transactions.slice().reverse();

            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="13" style="text-align: center; padding: 30px; color: #666;">
                            ยังไม่มีข้อมูลรายการ
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = data.map((t, index) => {
                let paymentType, paymentDetail;
                
                if (t.paymentType && t.paymentDetail !== undefined) {
                    paymentType = t.paymentType;
                    paymentDetail = t.paymentDetail;
                } else {
                    const paymentParts = t.paymentMethod.split(' ');
                    paymentType = paymentParts[0];
                    paymentDetail = paymentParts.slice(1).join(' ');
                }

                return `
                    <tr>
                        <td style="text-align: center;">${transactions.length - index}</td>
                        <td>${formatDateShort(t.date)}</td>
                        <td>${t.time}</td>
                        <td>${t.category}</td>
                        <td>${t.subCategory}</td>
                        <td>${paymentType}</td>
                        <td>${paymentDetail}</td>
                        <td>${t.detail}</td>
                        <td>${t.fund || ''}</td>
                        <td class="amount-cell ${t.type === 'Income' ? 'income-amount' : ''}" style="text-align: right;">
                            ${t.type === 'Income' ? formatNumber(t.amount) : ''}
                        </td>
                        <td class="amount-cell" style="text-align: right;">
                            ${t.type === 'Expenses' ? formatNumber(t.amount) : ''}
                        </td>
                        <td style="font-size: 10px; color: #666;">${t.atth || ''}</td>
                        <td>${t.comment}</td>
                    </tr>
                `;
            }).join('');
        }

        // Load Sample Data
        function loadSampleData() {
            const sampleData = [
                {
                    id: Date.now() + 1,
                    date: '2025-01-09',
                    time: '9:40:06',
                    dayOfWeek: 'วันพฤหัสบดี',
                    type: 'Expenses',
                    category: 'Medical Expenses',
                    subCategory: 'pranangklaohospital',
                    paymentType: 'Bank',
                    paymentDetail: 'KTB-NON',
                    paymentMethod: 'Bank KTB-NON',
                    detail: 'ค่าฟัน',
                    amount: 170.00,
                    comment: '',
                    fund: '',
                    atth: 'CustomerPhotos/Sept-2025/01'
                },
                {
                    id: Date.now() + 2,
                    date: '2025-01-09',
                    time: '11:47:39',
                    dayOfWeek: 'วันพฤหัสบดี',
                    type: 'Expenses',
                    category: 'Utility Bills',
                    subCategory: 'Top up phone',
                    paymentType: 'Bank',
                    paymentDetail: 'K-Bank',
                    paymentMethod: 'Bank K-Bank',
                    detail: 'เติมมือถือ',
                    amount: 20.00,
                    comment: '',
                    fund: '',
                    atth: 'CustomerPhotos/Sept-2025/02'
                },
                {
                    id: Date.now() + 3,
                    date: '2025-01-09',
                    time: '15:32:23',
                    dayOfWeek: 'วันพฤหัสบดี',
                    type: 'Expenses',
                    category: 'Investment',
                    subCategory: 'Gold Saving',
                    paymentType: 'Bank',
                    paymentDetail: 'KTB-NON',
                    paymentMethod: 'Bank KTB-NON',
                    detail: 'เงินออมทอง',
                    amount: 2008.00,
                    comment: '',
                    fund: '',
                    atth: 'CustomerPhotos/Sept-2025/03'
                },
                {
                    id: Date.now() + 4,
                    date: '2025-01-09',
                    time: '13:02:10',
                    dayOfWeek: 'วันพฤหัสบดี',
                    type: 'Expenses',
                    category: 'Medical Expenses',
                    subCategory: 'Dent CHULA',
                    paymentType: 'CreditCard',
                    paymentDetail: 'KTC',
                    paymentMethod: 'CreditCard KTC',
                    detail: 'ค่าฟันผู้ใหญ่',
                    amount: 780.00,
                    comment: '10:41',
                    fund: '',
                    atth: 'CustomerPhotos/Sept-2025/04'
                },
                {
                    id: Date.now() + 5,
                    date: '2025-01-09',
                    time: '10:31:16',
                    dayOfWeek: 'วันพฤหัสบดี',
                    type: 'Expenses',
                    category: 'Investment',
                    subCategory: 'Fund',
                    paymentType: 'Bank',
                    paymentDetail: 'K-Bank',
                    paymentMethod: 'Bank K-Bank',
                    detail: 'เงินซื้อกองทุน',
                    amount: 500.00,
                    comment: '',
                    fund: 'K-USXNDQ-A(D)',
                    atth: 'CustomerPhotos/Sept-2025/05'
                },
                {
                    id: Date.now() + 6,
                    date: '2025-01-09',
                    time: '8:07:33',
                    dayOfWeek: 'วันพฤหัสบดี',
                    type: 'Income',
                    category: 'Investment',
                    subCategory: 'Dividend',
                    paymentType: 'Bank',
                    paymentDetail: 'KTB-BKK',
                    paymentMethod: 'Bank KTB-BKK',
                    detail: 'เงินปันผลหุ้น',
                    amount: 418.50,
                    comment: '',
                    fund: '',
                    atth: 'CustomerPhotos/Sept-2025/06'
                }
            ];

            transactions.push(...sampleData);
            saveDataToStorage();
            updateStats();
            updateTransactionTable();
            showNotification('เพิ่มข้อมูลตัวอย่างเรียบร้อยแล้ว!', 'success');
        }

        // Clear All Data
        function clearAllData() {
            if (confirm('แน่ใจหรือไม่ที่จะลบข้อมูลทั้งหมด? การกระทำนี้ไม่สามารถย้อนกลับได้!')) {
                transactions = [];
                localStorage.removeItem('expenseTransactions');
                updateStats();
                updateTransactionTable();
                showNotification('ล้างข้อมูลทั้งหมดเรียบร้อยแล้ว!', 'info');
            }
        }

        // Export Functions
        function exportToCSV() {
            if (transactions.length === 0) {
                showNotification('ไม่มีข้อมูลให้ส่งออก!', 'error');
                return;
            }

            const headers = ['No.', 'Date', 'Time', 'Categorize', 'Type', 'PaymentType', 'PaymentDetail', 'Detail', 'Fund', 'Income', 'Expenses', 'Atth', 'Comment'];
            const csvData = [
                headers.join(','),
                ...transactions.map((t, index) => {
                    const paymentParts = t.paymentMethod.split(' ');
                    const paymentType = paymentParts[0];
                    const paymentDetail = paymentParts.slice(1).join(' ');
                    
                    return [
                        index + 1,
                        t.date,
                        t.time,
                        `"${t.category}"`,
                        `"${t.subCategory}"`,
                        `"${paymentType}"`,
                        `"${paymentDetail}"`,
                        `"${t.detail}"`,
                        `"${t.fund || ''}"`,
                        t.type === 'Income' ? t.amount : '',
                        t.type === 'Expenses' ? t.amount : '',
                        `"${t.atth || ''}"`,
                        `"${t.comment}"`
                    ].join(',');
                })
            ].join('\n');

            downloadFile(csvData, `transactions_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            showNotification('ส่งออกรายการเรียบร้อยแล้ว!', 'success');
        }

        function exportToJSON() {
            const data = {
                transactions: transactions,
                database: database,
                exportDate: new Date().toISOString()
            };

            const jsonData = JSON.stringify(data, null, 2);
            downloadFile(jsonData, `expense_data_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
            showNotification('ส่งออก JSON เรียบร้อยแล้ว!', 'success');
        }

        // Helper Functions
        function downloadFile(content, fileName, mimeType) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + content], { type: `${mimeType};charset=utf-8;` });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH', {
                style: 'currency',
                currency: 'THB'
            }).format(amount);
        }

        function formatDateShort(dateString) {
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear() + 543;
            return `${day}/${month}/${year}`;
        }

        function formatNumber(amount) {
            return new Intl.NumberFormat('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function showNotification(message, type = 'success') {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 4000);
        }

        // Fixed Google Sheets Integration without no-cors
        async function syncToGoogleSheets() {
            const form = document.getElementById('transactionForm');
            const syncButton = document.getElementById('syncButton');
            
            if (!form.checkValidity()) {
                showNotification('กรุณากรอกข้อมูลให้ครบถ้วน!', 'error');
                return;
            }

            // แสดง loading state
            syncButton.disabled = true;
            syncButton.innerHTML = '<span class="loading-spinner"></span>กำลังส่งข้อมูล...';

            const paymentType = document.getElementById('paymentType').value;
            const paymentDetail = document.getElementById('paymentDetail').value;
            
            const now = new Date();
            const transaction = {
                date: document.getElementById('date').value,
                time: now.toLocaleTimeString('th-TH', { hour12: false }),
                dayOfWeek: document.getElementById('dayOfWeek').value,
                type: document.getElementById('transactionType').value,
                category: document.getElementById('category').value,
                subCategory: document.getElementById('subCategory').value,
                paymentType: paymentType,
                paymentDetail: paymentDetail,
                detail: document.getElementById('detail').value,
                amount: parseFloat(document.getElementById('amount').value),
                comment: document.getElementById('comment').value || '',
                fund: '',
                atth: `CustomerPhotos/Sept-2025/${String(Math.floor(Math.random() * 100)).padStart(2, '0')}`
            };

            try {
                showNotification('กำลังส่งข้อมูลไป Google Sheets...', 'info');
                
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(transaction)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.status !== 'success') {
                    throw new Error(result.message || 'Unknown error');
                }

                // บันทึกในระบบด้วย
                transaction.id = Date.now();
                transactions.push(transaction);
                saveDataToStorage();
                updateStats();
                updateTransactionTable();
                
                const currentType = document.getElementById('transactionType').value;
                const currentCategory = document.getElementById('category').value;
                const currentSubCategory = document.getElementById('subCategory').value;
                if (currentType && currentCategory && currentSubCategory) {
                    updateDetailSuggestions(currentType, currentCategory, currentSubCategory);
                }
                
                form.reset();
                document.getElementById('date').valueAsDate = new Date();
                updateDayOfWeek();
                
                showNotification('บันทึกและส่งไป Google Sheets เรียบร้อยแล้ว!', 'success');
                
            } catch (error) {
                console.error('Error syncing to Google Sheets:', error);
                
                // แม้จะมี error แต่ยังคงบันทึกในระบบ
                transaction.id = Date.now();
                transactions.push(transaction);
                saveDataToStorage();
                updateStats();
                updateTransactionTable();
                
                form.reset();
                document.getElementById('date').valueAsDate = new Date();
                updateDayOfWeek();
                
                showNotification(`บันทึกในระบบเรียบร้อยแล้ว แต่เกิดข้อผิดพลาดในการส่งไป Google Sheets: ${error.message}`, 'warning');
            } finally {
                // คืนสถานะปุ่ม
                syncButton.disabled = false;
                syncButton.innerHTML = 'บันทึกและส่งไป Google Sheets';
            }
        }

        // Sync all transactions to Google Sheets (Fixed version)
        async function syncAllToGoogleSheets() {
            const syncAllButton = document.getElementById('syncAllButton');
            
            if (transactions.length === 0) {
                showNotification('ไม่มีข้อมูลให้ส่ง!', 'error');
                return;
            }

            if (!confirm(`คุณต้องการส่งข้อมูลทั้งหมด ${transactions.length} รายการไป Google Sheets หรือไม่?`)) {
                return;
            }

            // แสดง loading state
            syncAllButton.disabled = true;
            syncAllButton.innerHTML = '<span class="loading-spinner"></span>กำลังส่งข้อมูล...';

            try {
                showNotification('กำลังส่งข้อมูลทั้งหมดไป Google Sheets...', 'info');

                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(transactions)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.status !== 'success') {
                    throw new Error(result.message || 'Unknown error');
                }

                showNotification(`ส่งข้อมูลทั้งหมด ${transactions.length} รายการไป Google Sheets เรียบร้อยแล้ว!`, 'success');
                
            } catch (error) {
                console.error('Error syncing all data to Google Sheets:', error);
                showNotification(`เกิดข้อผิดพลาดในการส่งข้อมูลไป Google Sheets: ${error.message}`, 'error');
            } finally {
                // คืนสถานะปุ่ม
                syncAllButton.disabled = false;
                syncAllButton.innerHTML = 'ส่งทั้งหมดไป Google Sheets';
            }
        }

        // Storage Functions
        function saveDataToStorage() {
            localStorage.setItem('expenseTransactions', JSON.stringify(transactions));
        }

        function loadDataFromStorage() {
            const savedData = localStorage.getItem('expenseTransactions');
            if (savedData) {
                transactions = JSON.parse(savedData);
                
                const currentType = document.getElementById('transactionType').value;
                const currentCategory = document.getElementById('category').value;
                const currentSubCategory = document.getElementById('subCategory').value;
                if (currentType && currentCategory && currentSubCategory) {
                    updateDetailSuggestions(currentType, currentCategory, currentSubCategory);
                }
            }
        }
    </script>
</body>
</html>
